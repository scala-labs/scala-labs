package com.xebia.snippet

import net.liftweb.common.Loggable
import xml.NodeSeq

import net.liftweb.http.js._
import net.liftweb.http.js.JsCmds._
import net.liftweb.http.js.JE._
import net.liftweb.http._
import _root_.net.liftweb._
import util.Helpers._
import net.liftweb.http._
import net.liftweb.common._
import com.xebia.model._
import com.xebia.session._
import UserHolder._
import scala.xml._
import _root_.java.util.Date
import com.xebia.utils.Utils._

object GMaps extends StatefulSnippet {

  var dispatch: DispatchIt = {
    case "gmap" => gmap _
  }

  def gmap(xhtml: NodeSeq): NodeSeq = {


    bind("t", xhtml,
      "refresh" -> SHtml.ajaxButton("Refresh", () => refresh),
      "gmap" -> <div>{initMap}</div>)
  }

  def refresh(): JsCmd = {
    Position.findLatestForUser(currentUser) match {
      case Full(p) => updateMapWithPoint(p)
      case Empty => Noop
    }
  }

  def initMap() = {
    Position.findLatestForUser(currentUser) match {
      case Full(p) => onLoadScript(initMapWithPoint(p))
      case Empty => onLoadScript(initMapWithDefault())
    }
  }

  def updateMapWithPoint(p:Position) =  doMapWithPoint("updatepoint", p)
  def initMapWithPoint(p:Position) =  doMapWithPoint("initpoint", p)




  def initMapWithDefault(): JsCmd = {
    val latDefault = 52.22
    val lngDefault = 4.53
    Call("initmap", Num(latDefault), Num(lngDefault)) & SetHtml("unkownPos", <span>{"There are not recorded positions available."}</span>)
  }

  private def doMapWithPoint(func: String, p:Position): JsCmd = {
    val photo = if(currentUser.hasPhoto) <img src="/service/userimage" height="50" width="40"/> else <span/>
    val calloutTxt = new PrettyPrinter(50, 0).format(
      <div>
      {photo}
      <div float="left">
      <b>{currentUser.firstName + " " + currentUser.lastName}</b> <br/> <span>{"Last spotted: " + formatDateTime(p.recorded)}</span>
      </div>
      </div>)
    Call(func, Num(p.lat), Num(p.lng), Str(calloutTxt)) & SetHtml("unkownPos", <span/>)
  }


  /*
  val coordinates = List("-87.89289951324463,41.97881025520548,0", "-87.89184808731079,41.97788506340239,0", "-87.89150476455688,41.97762983571196,0", "-87.8912901878357,41.97750222148314,0", "-87.89090394973755,41.977326751500996,0", "-87.89047479629517,41.97719913666485,0", "-87.88987398147583,41.97707152157296,0", "-87.88912296295166,41.97702366584759,0", "-87.88856506347656,41.97708747347342,0", "-87.88757801055908,41.977326751500996,0", "-87.87487506866455,41.982574690129766,0", "-87.87399530410767,41.9828777493635,0", "-87.87305116653442,41.983101055244255,0", "-87.87238597869873,41.983196757524844,0", "-87.87172079086304,41.98327650931544,0", "-87.8705620765686,41.98346791320532,0", "-87.8670859336853,41.98394642041268,0", "-87.86622762680054,41.983994270935625,0", "-87.86554098129272,41.98401022110195,0", "-87.86120653152466,41.98367526677005,0", "-87.85824537277222,41.98353171437408,0", "-87.85753726959229,41.98354766465628,0", "-87.85320281982422,41.98372311749676,0", "-87.85275220870972,41.983739067731015,0", "-87.85230159759521,41.98380286862806,0", "-87.85122871398926,41.98383476905263,0", "-87.83650875091553,41.984281373318076,0", "-87.83138036727905,41.984504674276074,0", "-87.82994270324707,41.984520624314534,0", "-87.82902002334595,41.98447277418717,0", "-87.82820463180542,41.98447277418717,0", "-87.8272819519043,41.98444087408228,0", "-87.82620906829834,41.984345173671706,0", "-87.8248143196106,41.984201622786145,0", "-87.82307624816895,41.98401022110195,0", "-87.81835556030273,41.983356261006136,0", "-87.81533002853394,41.98265444269954,0", "-87.8138279914856,41.98235138240297,0", "-87.81303405761719,41.982271629453585,0", "-87.8121542930603,41.982255678851736,0", "-87.80685424804688,41.982271629453585,0", "-87.78539657592773,41.98239923412463,0", "-87.78486013412476,41.98235138240297,0", "-87.78436660766602,41.982255678851736,0", "-87.7838945388794,41.982144024526825,0", "-87.78310060501099,41.98185691250655,0", "-87.78181314468384,41.981186979424656,0", "-87.76951789855957,41.97426392485398,0", "-87.76625633239746,41.972445301840345,0", "-87.76541948318481,41.97203052089854,0", "-87.76466846466064,41.97175931651467,0", "-87.76419639587402,41.97159978398474,0", "-87.76344537734985,41.971392391098526,0", "-87.76207208633423,41.971057370394334,0", "-87.76097774505615,41.970674487431914,0", "-87.75140762329102,41.96520220027853,0", "-87.75017380714417,41.96442838413288,0", "-87.74977684020996,41.964197035212855,0", "-87.74924039840698,41.96394175267103,0", "-87.7481460571289,41.96354287165174,0", "-87.74613976478577,41.962904656826744,0", "-87.7448844909668,41.962338235815146,0", "-87.74352192878723,41.96138887099651,0", "-87.74210572242737,41.960232062813574,0", "-87.74102210998535,41.9595778585448,0", "-87.73595809936523,41.956721619774996,0", "-87.72894144058228,41.95283597213028,0", "-87.72202134132385,41.94890221074284,0", "-87.72173166275024,41.94876655946857,0", "-87.72151708602905,41.9486628259464,0", "-87.72124886512756,41.948551112733774,0", "-87.7208411693573,41.94840748117273,0", "-87.72015452384949,41.94812021707978,0", "-87.7197253704071,41.94788880895241,0", "-87.71940350532532,41.9476254814409,0", "-87.71909236907959,41.947378112181646,0", "-87.71864175796509,41.946875391052195,0", "-87.7183735370636,41.94643650428536,0", "-87.71816968917847,41.94613327166335,0", "-87.71771907806396,41.94533528418746,0", "-87.71742939949036,41.94480860698191,0", "-87.71689295768738,41.94391484176801,0", "-87.71654963493347,41.94341209332932,0", "-87.71623849868774,41.94308490570803,0", "-87.7159595489502,41.94280559787368,0", "-87.7154552936554,41.94242254513981,0", "-87.71505832672119,41.942159195050415,0", "-87.71460771560669,41.94191180458167,0", "-87.71215081214905,41.939062754848564,0", "-87.708549,41.929631,0", "-87.70646452903748,41.92837568914348,0", "-87.70588517189026,41.927944657144785,0", "-87.70554184913635,41.92757747944137,0", "-87.70499467849731,41.92709056661877,0", "-87.70466208457947,41.92682715321491,0", "-87.70442605018616,41.92663557914714,0", "-87.70417928695679,41.92645996907967,0", "-87.70337462425232,41.92593313597692,0", "-87.69702315330505,41.92209350879694,0", "-87.68695950508118,41.9159304640514,0", "-87.67834424972534,41.91032572790956,0", "-87.67821550369263,41.910213947539546,0", "-87.67807602882385,41.910110151306405,0", "-87.67772197723389,41.909894573975215,0", "-87.66998648643494,41.90494407940173,0", "-87.666705,41.903343,0", "-87.655618,41.896217,0", "-87.647833,41.891186,0", "-87.631714,41.885890,0", "-87.629300,41.882377,0", "-87.629507,41.880464,0", "-87.629390,41.877769,0", "-87.632246,41.875818,0", "-87.641113,41.876444,0", "-87.647296,41.876324,0", "-87.65696704387665,41.87587214296158,0", "-87.66885459423065,41.87576829090648,0", "-87.67344653606415,41.875664438682605,0", "-87.68649280071259,41.87554460898384,0", "-87.69629895687103,41.875440756396515,0", "-87.69729673862457,41.875440756396515,0", "-87.69806921482086,41.875424779060396,0", "-87.6985090970993,41.875416790390844,0", "-87.69898116588593,41.87537684702812,0", "-87.69945323467255,41.87535288099851,0", "-87.69987165927887,41.8753049489123,0", "-87.70080506801605,41.87519310723801,0", "-87.7020388841629,41.875009366919706,0", "-87.70577251911163,41.8744900979469,0", "-87.70651280879974,41.874338310834915,0", "-87.70694196224213,41.87429836679819,0", "-87.70734965801239,41.87425043392114,0", "-87.70830452442169,41.874154568059204,0", "-87.72555649280548,41.8738909361975,0", "-87.73264825344086,41.873819036410126,0", "-87.73310959339142,41.873795069796365,0", "-87.73347437381744,41.87374713654187,0", "-87.73379623889923,41.87369920325143,0", "-87.7341502904892,41.87362730324836,0", "-87.7344936132431,41.873539425357045,0", "-87.7349442243576,41.87341959167411,0", "-87.73527681827545,41.873299757766524,0", "-87.73559868335724,41.87315595678084,0", "-87.73592054843903,41.87302014444176,0", "-87.73619949817657,41.872900309785294,0", "-87.73654282093048,41.87273254088877,0", "-87.73684322834015,41.87258873862697,0", "-87.73708999156952,41.872460914122684,0", "-87.73748695850372,41.87230912219183,0", "-87.73775517940521,41.872197275275255,0", "-87.73808777332306,41.87209341724893,0", "-87.73845255374908,41.871981569954926,0", "-87.73880660533905,41.871901678910824,0", "-87.73906409740448,41.871837766003644,0", "-87.73932158946991,41.87178983128131,0", "-87.73961126804352,41.87174189652303,0", "-87.7399331331253,41.871709939997544,0", "-87.74024426937103,41.87170195086369,0", "-87.74512588977814,41.87160608117939,0", "-87.75847256183624,41.871486243871814,0", "-87.75879442691803,41.87149423303264,0", "-87.7590411901474,41.87147825471,0", "-87.75923430919647,41.87144629805271,0", "-87.75942742824554,41.87141434137945,0", "-87.75967419147491,41.87133444962639,0", "-87.76000678539276,41.87125455777348,0", "-87.76033937931061,41.87112673060111,0", "-87.7606612443924,41.870990913950415,0", "-87.76128351688385,41.87068732274654,0", "-87.76164829730988,41.870519548041614,0", "-87.76197016239166,41.87038373010081,0", "-87.76229202747345,41.870279869127835,0", "-87.76258170604706,41.8701919866343,0", "-87.76283919811249,41.870136061348234,0", "-87.76309669017792,41.87009611468537,0", "-87.76338636875153,41.87006415733709,0", "-87.76379406452179,41.87004018931541,0", "-87.76416957378387,41.87006415733709,0", "-87.76468455791473,41.87010410401993,0", "-87.7651995420456,41.87012807201764,0", "-87.76691615581512,41.870279869127835,0", "-87.76747405529022,41.87031981567587,0", "-87.7679032087326,41.87035177289634,0", "-87.76870787143707,41.870415687289324,0", "-87.77046740055084,41.870511558758956,0", "-87.77282774448395,41.87065536569383,0", "-87.77452290058136,41.870767215308405,0", "-87.77611076831818,41.8708471077704,0", "-87.77790248394012,41.870966946276205,0", "-87.77926504611969,41.87107879534559,0", "-87.78161466121674,41.87127053615203,0", "-87.78339564800262,41.871422330549265,0", "-87.78476893901825,41.871526189665985,0", "-87.78622806072235,41.8716540160395,0", "-87.78818070888519,41.87181379864696,0", "-87.79055178165436,41.871997548151754,0", "-87.79254734516144,41.87218129712835,0", "-87.79381334781647,41.8722771659499,0", "-87.80135571956635,41.87299617752844,0", "-87.80474603176117,41.873339702427344,0", "-87.8079754114151,41.87365126992505,0", "-87.80918776988983,41.873771103173596,0", "-87.81001389026642,41.873843003014905,0", "-87.81053960323334,41.87386696961068,0", "-87.81159102916718,41.87388294733622,0", "-87.8122991323471,41.87383501414763,0", "-87.81289994716644,41.873771103173596,0", "-87.81329691410065,41.87369121436618,0", "-87.81351149082184,41.87366724770451,0", "-87.81365096569061,41.87365925881527,0", "-87.81384408473969,41.87366724770451,0", "-87.814080119133,41.873731158782384,0", "-87.81429469585419,41.873819036410126,0", "-87.81459510326385,41.87393886934416,0", "-87.8148204088211,41.8740507132132,0", "-87.81505644321442,41.874122612739946,0", "-87.8154319524765,41.87417853453816,0", "-87.81619369983673,41.874218478649816,0", "-87.8154319524765,41.87417853453816,0", "-87.81505644321442,41.874122612739946,0", "-87.8148204088211,41.8740507132132,0", "-87.81459510326385,41.87393886934416,0", "-87.81429469585419,41.873819036410126,0", "-87.814080119133,41.873731158782384,0", "-87.81384408473969,41.87366724770451,0", "-87.81365096569061,41.87365925881527,0", "-87.81351149082184,41.87366724770451,0", "-87.81329691410065,41.87369121436618,0", "-87.81289994716644,41.873771103173596,0", "-87.8122991323471,41.87383501414763,0", "-87.81159102916718,41.87388294733622,0", "-87.81053960323334,41.87386696961068,0", "-87.81001389026642,41.873843003014905,0", "-87.80918776988983,41.873771103173596,0", "-87.8079754114151,41.87365126992505,0", "-87.80474603176117,41.873339702427344,0", "-87.80135571956635,41.87299617752844,0", "-87.79381334781647,41.8722771659499,0", "-87.79254734516144,41.87218129712835,0", "-87.79055178165436,41.871997548151754,0", "-87.78818070888519,41.87181379864696,0", "-87.78622806072235,41.8716540160395,0", "-87.78476893901825,41.871526189665985,0", "-87.78339564800262,41.871422330549265,0", "-87.78161466121674,41.87127053615203,0", "-87.77926504611969,41.87107879534559,0", "-87.77790248394012,41.870966946276205,0", "-87.77611076831818,41.8708471077704,0", "-87.77452290058136,41.870767215308405,0", "-87.77282774448395,41.87065536569383,0", "-87.77046740055084,41.870511558758956,0", "-87.76870787143707,41.870415687289324,0", "-87.7679032087326,41.87035177289634,0", "-87.76747405529022,41.87031981567587,0", "-87.76691615581512,41.870279869127835,0", "-87.7651995420456,41.87012807201764,0", "-87.76468455791473,41.87010410401993,0", "-87.76416957378387,41.87006415733709,0", "-87.76379406452179,41.87004018931541,0", "-87.76338636875153,41.87006415733709,0", "-87.76309669017792,41.87009611468537,0", "-87.76283919811249,41.870136061348234,0", "-87.76258170604706,41.8701919866343,0", "-87.76229202747345,41.870279869127835,0", "-87.76197016239166,41.87038373010081,0", "-87.76164829730988,41.870519548041614,0", "-87.76128351688385,41.87068732274654,0", "-87.7606612443924,41.870990913950415,0", "-87.76033937931061,41.87112673060111,0", "-87.76000678539276,41.87125455777348,0", "-87.75967419147491,41.87133444962639,0", "-87.75942742824554,41.87141434137945,0", "-87.75923430919647,41.87144629805271,0", "-87.7590411901474,41.87147825471,0", "-87.75879442691803,41.87149423303264,0", "-87.75847256183624,41.871486243871814,0", "-87.74512588977814,41.87160608117939,0", "-87.74024426937103,41.87170195086369,0", "-87.7399331331253,41.871709939997544,0", "-87.73961126804352,41.87174189652303,0", "-87.73932158946991,41.87178983128131,0", "-87.73906409740448,41.871837766003644,0", "-87.73880660533905,41.871901678910824,0", "-87.73845255374908,41.871981569954926,0", "-87.73808777332306,41.87209341724893,0", "-87.73775517940521,41.872197275275255,0", "-87.73748695850372,41.87230912219183,0", "-87.73708999156952,41.872460914122684,0", "-87.73684322834015,41.87258873862697,0", "-87.73654282093048,41.87273254088877,0", "-87.73619949817657,41.872900309785294,0", "-87.73592054843903,41.87302014444176,0", "-87.73559868335724,41.87315595678084,0", "-87.73527681827545,41.873299757766524,0", "-87.7349442243576,41.87341959167411,0", "-87.7344936132431,41.873539425357045,0", "-87.7341502904892,41.87362730324836,0", "-87.73379623889923,41.87369920325143,0", "-87.73347437381744,41.87374713654187,0", "-87.73310959339142,41.873795069796365,0", "-87.73264825344086,41.873819036410126,0", "-87.72555649280548,41.8738909361975,0", "-87.70830452442169,41.874154568059204,0", "-87.70734965801239,41.87425043392114,0", "-87.70694196224213,41.87429836679819,0", "-87.70651280879974,41.874338310834915,0", "-87.70577251911163,41.8744900979469,0", "-87.7020388841629,41.875009366919706,0", "-87.70080506801605,41.87519310723801,0", "-87.69987165927887,41.8753049489123,0", "-87.69945323467255,41.87535288099851,0", "-87.69898116588593,41.87537684702812,0", "-87.6985090970993,41.875416790390844,0", "-87.69806921482086,41.875424779060396,0", "-87.69729673862457,41.875440756396515,0", "-87.69629895687103,41.875440756396515,0", "-87.68649280071259,41.87554460898384,0", "-87.67344653606415,41.875664438682605,0", "-87.66885459423065,41.87576829090648,0", "-87.65696704387665,41.87587214296158,0", "-87.66885459423065,41.87576829090648,0", "-87.66909062862396,41.87571237049921,0", "-87.66931593418121,41.875632484118256,0", "-87.66943395137787,41.87553662032928,0", "-87.6695305109024,41.87540081304875,0", "-87.66960561275482,41.875225062022075,0", "-87.66968071460724,41.87512120891551,0", "-87.669511,41.871432,0", "-87.66912281513214,41.85537806555371,0", "-87.6691335439682,41.85523422425483,0", "-87.66915500164032,41.855138329875835,0", "-87.6691871881485,41.855066408997246,0", "-87.6692408323288,41.85499448803779,0", "-87.66931593418121,41.85491457576575,0", "-87.66939103603363,41.85484265463553,0", "-87.66945540904999,41.85478671592279,0", "-87.66957342624664,41.8547387684158,0", "-87.66973435878754,41.8546828296122,0", "-87.66989529132843,41.85463488202732,0", "-87.6700347661972,41.85462689075967,0", "-87.6701956987381,41.85461090822141,0", "-87.67051756381989,41.85460291695075,0", "-87.67803847789764,41.854491039056995,0", "-87.68537700176239,41.85440313486035,0", "-87.69493639469147,41.85429125661714,0", "-87.70554721355438,41.854131430215915,0", "-87.70873367786407,41.85406749954361,0", "-87.71495640277863,41.85398758611336,0", "-87.724684,41.853946,0", "-87.7322405576706,41.85377981072743,0", "-87.73435413837433,41.85374784522355,0", "-87.73464381694794,41.85374784522355,0", "-87.73485839366913,41.85373985384506,0", "-87.73501932621002,41.8537078883212,0", "-87.73518025875092,41.853683914167824,0", "-87.73528754711151,41.853635965834094,0", "-87.73548066616058,41.85358801746443,0", "-87.73559868335724,41.85351609484254,0", "-87.73573815822601,41.85344417213976,0", "-87.73587763309479,41.85334827507694,0", "-87.7360600233078,41.853180454871016,0", "-87.73666083812714,41.85254912729531,0", "-87.73677885532379,41.852461220429795,0", "-87.73689687252045,41.85236532189326,0", "-87.73705780506134,41.852285406336286,0", "-87.73721873760223,41.852197499108314,0", "-87.73737967014313,41.85214155808217,0", "-87.73756206035614,41.8521016001764,0", "-87.73778736591339,41.85206164224564,0", "-87.73803412914276,41.85206164224564,0", "-87.74552285671234,41.85189381866398,0", "-87.7565735578537,41.85182988575514,0");

  Alert("You must provide a name").toJsCmd
  def genTrack(id:String) = kmlTemplate(id, coordinates);


  def kmlTemplate(id:String, coordinates: List[String]) =  {
    println("ID is " + id)
    <kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
      <name>Paths</name>
      <description>Examples of paths. Note that the tessellate tag is by default
      set to 0. If you want to create tessellated lines, they must be authored
      (or edited) directly in KML.</description>
      <Style id="yellowLineGreenPoly">
        <LineStyle>
          <color>7f00ffff</color>
          <width>4</width>
        </LineStyle>
      </Style>
      <Style id="redLine">
        <LineStyle>
          <color>ff0000ff</color>
          <width>4</width>
        </LineStyle>
      </Style>
      <Placemark>
        <name>Absolute Extruded</name>
        <description>Transparent green wall with yellow outlines</description>
        <styleUrl>#yellowLineGreenPoly</styleUrl>
        <LineString>
          <extrude>1</extrude>
          <tessellate>1</tessellate>
          <altitudeMode>absolute</altitudeMode>
          <coordinates>
{for (coordinate <- coordinates) yield coordinate + " \r\n"}
          </coordinates>
        </LineString>
      </Placemark>
    </Document>
  </kml>
                    }
  */
}